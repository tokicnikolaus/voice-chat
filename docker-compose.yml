version: '3.8'

services:
  # LiveKit SFU Server
  livekit:
    image: livekit/livekit-server:latest
    command: --config /etc/livekit.yaml --node-ip 192.168.0.130
    restart: always
    ports:
      - "7880:7880"             # HTTP API
      - "7881:7881"             # WebRTC TCP
      - "7882-7892:7882-7892/udp" # WebRTC UDP range
    volumes:
      - ./livekit.yaml:/etc/livekit.yaml:ro
    networks:
      - voice-chat-network

  # Redis for chat persistence
  redis:
    image: redis:7-alpine
    restart: always
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data
    networks:
      - voice-chat-network
    command: redis-server --appendonly yes

  # Go Backend Server
  server:
    build: ./server
    restart: always
    ports:
      - "8080:8080"
    environment:
      - SERVER_PORT=8080
      - LIVEKIT_URL=ws://livekit:7880
      - LIVEKIT_PUBLIC_URL=ws://192.168.0.130:7880
      - LIVEKIT_API_KEY=devkey
      - LIVEKIT_API_SECRET=devkey-secret-key-for-livekit-minimum-32-characters-long-required
      - ADMIN_PASSWORD=${ADMIN_PASSWORD:-admin123}
      - ADMIN_ALLOWED_IPS=${ADMIN_ALLOWED_IPS:-}
      - DEFAULT_ROOM_CAPACITY=15
      - ROOM_CLEANUP_MINUTES=10
      - LOG_LEVEL=info
      - REDIS_ENABLED=true
      - REDIS_ADDR=redis:6379
      - REDIS_PASSWORD=
      - REDIS_DB=0
      - AUTH_API_BASE_URL=${AUTH_API_BASE_URL}
    depends_on:
      - livekit
      - redis
    networks:
      - voice-chat-network

  # React Frontend
  client:
    build: ./client
    restart: always
    ports:
      - "3000:80"   # HTTP (redirects to HTTPS)
      - "3443:443"  # HTTPS
    depends_on:
      - server
    networks:
      - voice-chat-network

networks:
  voice-chat-network:
    driver: bridge

volumes:
  redis-data:
